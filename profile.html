<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Profile</title>
	<script type="text/javascript" src="tabulator.min.js"></script>
	<script type="text/javascript" src="peity-vanilla.min.js"></script>
	<script type="text/javascript" src="flatpickr.min.js"></script>
	<link href="tabulator.min.css" rel="stylesheet">
	<link href="flatpickr.min.css" rel="stylesheet">
	<link href="style.css" rel="stylesheet">
	<script src="plotly-3.0.0.min.js" charset="utf-8"></script>
	<script src="math.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<link rel="icon" type="image/x-icon" href="logos/icon.png">
</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FX06BZ5MRL"></script>
<script>
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());

	gtag('config', 'G-FX06BZ5MRL');
</script>

<style>
	body {
		margin: 0; padding: 0;
		font-size: 18px;
		height: 100vh;
	}
	#discord_username {
		margin-bottom: 0.5rem;
	}
	.discord-error {
	  background: #ffefef;
	  color: #b30000;
	  padding: 1rem;
	  border: 1px solid #b30000;
	  border-radius: 4px;
	  margin-bottom: 1rem;
	  font-size: 0.9rem;
	  text-align: center;
	}
	.discord-error a {
	  color: #b30000;
	  font-weight: bold;
	}
	.discord-error button {
	  background: #b30000;
	  color: #fff;
	  border: none;
	  padding: 0.3rem 0.6rem;
	  border-radius: 4px;
	  cursor: pointer;
	}
	.discord-error button:hover {
	  background: #ff4d4d;
	}
	.discord-success {
	  background: #e6ffed;
	  color: #14532d;
	  padding: 1rem;
	  border: 1px solid #1bb34b;
	  border-radius: 4px;
	  margin-bottom: 1rem;
	  font-size: 0.9rem;
	  text-align: center;
	}
	.discord-success strong {
	  font-weight: 600;
	}
	
	@media (max-width: 600px) {
	}
</style>
<body>
	<div id="header">
		<div id="title">
			<h1>+EV Dingers</h1>
		</div>
		<div id="sub-header">
			<div class="dropdown">
				<select id="page-select"></select>
				<svg viewBox="0 0 24 24" width="24" height="24" xmlns="http://www.w3.org/2000/svg" class="dropdown__arrow css-jbgpyq ehya2ln0" fill="#A4A4AA" stroke="#A4A4AA" stroke-width="0"><title>Right Arrow</title><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"></path></svg>
			</div>
		</div>
		<div id="auth-buttons">
			<button id="discord-login" class="oauth-btn discord-btn">
				<img src="/logos/discord.png" alt="Discord logo" class="oauth-icon">
				Sign in with Discord
			</button>
			<span id="username" class="username"></span>
			<button id="pricing" class="loggedOut" onclick="changePage('pricing')">Pricing</button>
			<button id="account" class="loggedIn" onclick="changePage('profile')">Profile</button>
			<button id="upgrade" class="loggedIn" onclick="changePage('pricing')">Upgrade üéØ</button>
			<button id="logout" class="loggedIn" onclick="logout()">Logout</button>
		</div>
	</div>
	<div class="profile-container">
		<div class="profile-header">
			<div class="profile-badge"></div>
			<div id="profile-info">
				<h2 id="profile-username"></h2>
				<button class="upgrade-btn" onclick="changePage('pricing')">Upgrade / Manage</button>
			</div>
		</div>
		<div class="profile-subscription">
			<h3>Subscription Details</h3>
			<div class="sub-grid">
				<div>
					<span class="label">Plan:</span>
					<span id="profile-plan" class="value">loading...</span>
				</div>
				<div>
					<span class="label">Next Renewal:</span>
					<span id="next-renewal" class="value">loading...</span>
				</div>
				<div>
					<span class="label">Discord:</span>
					<span class="value">
						<span id="discord-username">loading...</span>
					</span>
				</div>
			</div>
			<div id="discord-error"></div>
			<!-- Quick Links -->
			<div class="profile-links">
				<h3>Account Actions</h3>
				<button id="link-discord-btn" class="link-btn" onclick="connectDiscord()">
					Connect Discord
					<span class="spinner" style="display: none;"></span>
				</button>
				<button class="link-btn" onclick="cancelSubscription()">‚ùå Cancel Subscription</button>
			</div>
		</div>
	</div>
	<footer class="site-footer">
		<p>All content is for entertainment purposes only. +EV Dingers is not affiliated with MLB. <a href="/disclaimer">Read Full Terms</a></p>
	</footer>
	<script src="auth.js"></script>
	<script type="text/javascript" src="shared.js"></script>
	<script type="text/javascript">
		PAGE = "profile";
		const windowURL = new URL(window.location.href);
		const URLParams = new URLSearchParams(windowURL.search);
		let discordError = URLParams.get("discordError");
		let discordSuccess = URLParams.get("discordSuccess");

		document.getElementById('discord-login').addEventListener('click', async () => {
		  const { data, error } = await SB.auth.signInWithOAuth({
		    provider: 'discord',
		    options: {
		      redirectTo: window.location.origin + '/profile.html'
		    }
		  });
		  if (error) {
		    console.error('Discord login failed:', error.message);
		    alert('Unable to log in with Discord. Please try again.');
		  }
		});

		const linkBtn = document.getElementById("link-discord-btn");
		const spinner = linkBtn.querySelector('.spinner');
		const btnText = linkBtn.querySelector('.btn-text');

		linkBtn.addEventListener('click', () => {
			spinner.style.display = 'inline-block';
			btnText.textContent = 'Connecting‚Ä¶';
			linkBtn.disabled = true;

			window.location.href = `${API_BASE}/api/discord/login`;
		});

		if (discordSuccess != undefined) {
			// Create a success message container
		  const successMsg = document.createElement('div');
		  successMsg.className = 'discord-success';
		  successMsg.innerHTML = `
		    ‚úÖ <strong>Success!</strong> Your Discord account has been linked. üéâ<br>
		    Enjoy your +EV channels and perks!
		  `;
		  // Insert it near the top of the profile container
		  document.querySelector('.profile-container').prepend(successMsg);

		  // Clean up the URL so the param isn't visible anymore
			const newUrl = `${window.location.pathname}`;
			history.replaceState({}, '', newUrl);
		}

		if (discordError === "not_in_guild") {
			const msg = document.createElement('div');
	    msg.className = 'discord-error';
	    msg.innerHTML = `
	      ‚ö†Ô∏è You‚Äôve linked your Discord account, but you haven‚Äôt joined our server yet.<br>
	      <a href="https://discord.gg/JQq3MHWj" target="_blank">üëâ Join the Discord here üëà</a><br>
	      After joining, click <button id="recheck-roles">Recheck Roles</button>.
	    `;
	    document.querySelector('.profile-container').prepend(msg);

	    document.getElementById('recheck-roles').addEventListener('click', async () => {
	      // Optional: hit an endpoint to retry role assignment
	      await fetch('/api/discord/recheck', {
	        method: 'POST',
	        headers: { Authorization: `Bearer ${ACCESS_TOKEN}` }
	      });
	      alert("We'll re-check your roles shortly.");
	    });
	    // Clean up the URL so the param isn't visible anymore
			const newUrl = `${window.location.pathname}`;
			history.replaceState({}, '', newUrl);
		}

		async function connectDiscord() {
			/*
			const response = await fetch('http://localhost:5000/api/discord/login', {
				method: 'POST',
				headers: { 
					Authorization: `Bearer ${ACCESS_TOKEN}`
				},
			});
			const data = await response.json();
			*/
			const { data: { session }, error } = await SB.auth.getSession();
			window.location.href = "http://localhost:5000/api/discord/login?user_id="+session.user.id;
		}

		async function cancelSubscription() {
			const response = await fetch('/api/create-portal-session', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({ customerId: "CURRENT_USER_CUSTOMER_ID" })
		});
		const data = await response.json();
		window.location.href = data.url; // Stripe handles the rest
			}
	</script>
</body>
</html>
